variables:
  CI_IMAGE: rootlogin/nextcloud
  BUILDX_VER: 0.5.1

stages:
  - build
  - deploy

services:
  - docker:dind

before_script:
  - export DOCKER_CLI_EXPERIMENTAL=enabled
  - mkdir -p /root/.docker/cli-plugins
  - wget -qO ~/.docker/cli-plugins/docker-buildx https://github.com/docker/buildx/releases/download/v${BUILDX_VER}/buildx-v${BUILDX_VER}.linux-amd64
  - chmod +x /root/.docker/cli-plugins/docker-buildx
  - docker login -u "$DOCKERHUB_USERNAME" -p "$DOCKERHUB_TOKEN"
  - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
  - docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
  - docker buildx create --use

build-amd64:
  image: docker:latest
  stage: build
  script:
    - docker buildx build --push
      --platform linux/amd64
      --build-arg "VCS_REF=$CI_COMMIT_SHORT_SHA" 
      --build-arg 'BUILD_DATE=`date -u +"%Y-%m-%dT%H:%M:%SZ"`' 
      -t "$CI_IMAGE:$CI_COMMIT_REF_SLUG-amd64" .

build-x86:
  image: docker:latest
  stage: build
  script:
    - docker buildx build --push
      --platform linux/386
      --build-arg "VCS_REF=$CI_COMMIT_SHORT_SHA" 
      --build-arg 'BUILD_DATE=`date -u +"%Y-%m-%dT%H:%M:%SZ"`' 
      -t "$CI_IMAGE:$CI_COMMIT_REF_SLUG-x86" .

build-arm64:
  image: docker:latest
  stage: build
  script:
    - docker buildx build --push
      --platform linux/arm64/v8
      --build-arg "VCS_REF=$CI_COMMIT_SHORT_SHA" 
      --build-arg 'BUILD_DATE=`date -u +"%Y-%m-%dT%H:%M:%SZ"`' 
      -t "$CI_IMAGE:$CI_COMMIT_REF_SLUG-arm64" .

build-armv7:
  image: docker:latest
  stage: build
  script:
    - docker buildx build --push
      --platform linux/arm/v7
      --build-arg "VCS_REF=$CI_COMMIT_SHORT_SHA" 
      --build-arg 'BUILD_DATE=`date -u +"%Y-%m-%dT%H:%M:%SZ"`' 
      -t "$CI_IMAGE:$CI_COMMIT_REF_SLUG-armv7" .

build-ppc64le:
  image: docker:latest
  stage: build
  script:
    - docker buildx build --push
      --platform linux/ppc64le
      --build-arg "VCS_REF=$CI_COMMIT_SHORT_SHA" 
      --build-arg 'BUILD_DATE=`date -u +"%Y-%m-%dT%H:%M:%SZ"`' 
      -t "$CI_IMAGE:$CI_COMMIT_REF_SLUG-ppc64le" .

build-s390x:
  image: docker:latest
  stage: build
  script:
    - docker buildx build --push
      --platform linux/s390x
      --build-arg "VCS_REF=$CI_COMMIT_SHORT_SHA" 
      --build-arg 'BUILD_DATE=`date -u +"%Y-%m-%dT%H:%M:%SZ"`' 
      -t "$CI_IMAGE:$CI_COMMIT_REF_SLUG-s390x" .

deploy-docker-hub:
  image: docker:latest
  stage: deploy
  script:
    - docker pull "$CI_IMAGE:$CI_COMMIT_REF_SLUG-amd64"
    - docker pull "$CI_IMAGE:$CI_COMMIT_REF_SLUG-x86"
    - docker pull "$CI_IMAGE:$CI_COMMIT_REF_SLUG-arm64"
    - docker pull "$CI_IMAGE:$CI_COMMIT_REF_SLUG-armv7"
    - docker pull "$CI_IMAGE:$CI_COMMIT_REF_SLUG-ppc64le"
    - docker pull "$CI_IMAGE:$CI_COMMIT_REF_SLUG-s390x"
    - docker manifest create
      "$CI_IMAGE:$CI_COMMIT_REF_SLUG"
      --amend "$CI_IMAGE:$CI_COMMIT_REF_SLUG-amd64"
      --amend "$CI_IMAGE:$CI_COMMIT_REF_SLUG-x86"
      --amend "$CI_IMAGE:$CI_COMMIT_REF_SLUG-arm64"
      --amend "$CI_IMAGE:$CI_COMMIT_REF_SLUG-armv7"
      --amend "$CI_IMAGE:$CI_COMMIT_REF_SLUG-ppc64le"
      --amend "$CI_IMAGE:$CI_COMMIT_REF_SLUG-s390x"
    - docker manifest push "$CI_IMAGE:$CI_COMMIT_REF_SLUG"