name: docker

on: [ push, pull_request ]

jobs:
  build-env:
    runs-on: ubuntu-latest
    outputs:
      docker-tag: ${{ steps.docker-tag.outputs.tag }}
    steps:
      - name: Retrieve docker tag
        shell: bash
        run: |
          export BRANCH_NAME=${GITHUB_REF#refs/heads/}

          [ "$BRANCH_NAME" == "master" ] && export DOCKER_TAG="latest" || export DOCKER_TAG="$BRANCH_NAME"
          echo "::set-output name=tag::$DOCKER_TAG"
        id: docker-tag

  build-amd64:
    runs-on: ubuntu-latest
    needs: [ build-env ]
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v1
      - name: Build
        run: |
          docker buildx build \
            --platform linux/amd64 \
            --build-arg "VCS_REF=$CI_COMMIT_SHORT_SHA" \
            --build-arg 'BUILD_DATE=`date -u +"%Y-%m-%dT%H:%M:%SZ"`' \
            -t "rootlogin/nextcloud:${{ needs.build-env.outputs.docker-tag }}-amd64" .

  build-x86:
    runs-on: ubuntu-latest
    needs: [ build-env ]
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v1
      - name: Build
        shell: bash
        run: |
          docker buildx build \
            --platform linux/386 \
            --build-arg "VCS_REF=$CI_COMMIT_SHORT_SHA" \
            --build-arg 'BUILD_DATE=`date -u +"%Y-%m-%dT%H:%M:%SZ"`' \
            -t "rootlogin/nextcloud:${{ needs.build-env.outputs.docker-tag }}-x86" .

